

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Control Loops &mdash; Game Manual 0 0.0.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/gm0-logo.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/gm0-rtd.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Appendix" href="../appendix/index.html" />
    <link rel="prev" title="Programming Tutorial - Mecanum Drivetrain" href="mecanum-drive.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Game Manual 0
          

          
            
            <img src="../../_static/gm0-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Game Manual 0 Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../meta/index.html">Meta</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started-in-ftc/index.html">Getting Started in FTC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rookie-mistakes/index.html">Rookie Mistakes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../kit-and-hardware-guide/index.html">Kit and Hardware Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools-list.html">Tools List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../materials-guide.html">Materials Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../drivetrains/index.html">Drivetrains</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../power-transmission/index.html">Power Transmission</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linear-motion-guide/index.html">Linear Motion Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arms/index.html">Arms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../passive-intake/index.html">Passive Intake/Claw</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../active-intake/index.html">Active Intake</a></li>
<li class="toctree-l1"><a class="reference internal" href="../motor-guide/index.html">Motor Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../servo-guide/index.html">Servo Guide</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../electronics/index.html">Electronics</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Software</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="fundamental-concepts.html">Fundamental Concepts of Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="options-for-programming.html">Options for Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="using-the-sdk.html">Using the FTC SDK</a></li>
<li class="toctree-l2"><a class="reference internal" href="mecanum-drive.html">Programming Tutorial - Mecanum Drivetrain</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Control Loops</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendix/index.html">Appendix</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Game Manual 0</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Software</a> &raquo;</li>
        
      <li>Control Loops</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/docs/software/control-loops.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="control-loops">
<h1>Control Loops<a class="headerlink" href="#control-loops" title="Permalink to this headline">¶</a></h1>
<p>Control loops are software used to operate power transmission systems
(such as a drivetrain or linear slide) in a fast and controlled fashion.
Not only do control loops let you run mechanisms quickly without fear of losing
control, in many cases, they help preserve the longevity of mechanisms by
reducing rapid change of applied motor voltage.</p>
<div class="section" id="what-is-error">
<h2>What is Error?<a class="headerlink" href="#what-is-error" title="Permalink to this headline">¶</a></h2>
<p>The first thing that must be defined when discussing control loops is the
concept of error.
Error is defined as the difference between where you are and where you want to
be.
For instance, say you tell your drivetrain to drive at 30 inches per second,
but in actuality, at a time, the drivetrain is driving at 28 inches per second.
Since <img class="math" src="../../_images/math/ffff1a1631a06f1b2fccb2a63bdb21dcbfaf9f9f.svg" alt="30-28=2"/>, the error of the drivetrain’s speed at this time
<img class="math" src="../../_images/math/e8dea8254118f111b5fb20895b03528c17566f06.svg" alt="T"/> is 2 inches per second. In other words, at a time
<img class="math" src="../../_images/math/24417e096b9190c9c1cb0ecaf5bf8d93f707374e.svg" alt="t=T"/>, <img class="math" src="../../_images/math/6063e403eea5c58e8a7fe33a1a55b31befcc070b.svg" alt="e(t)=2"/>.</p>
</div>
<div class="section" id="pid">
<h2>PID<a class="headerlink" href="#pid" title="Permalink to this headline">¶</a></h2>
<p>A PID controller (or Proportional Integral Derivative controller) is a control
loop that solely uses error to control the system.
PID is a form of a <strong>feedback control loop</strong>, or <strong>closed loop control</strong>.
This means that data about the variable you are controlling is required in order
for the loop to control that variable.
In this case, information about the <strong>error</strong> of the system is required to
control the system with a PID controller.</p>
<div class="section" id="the-optional-calculus">
<h3>The Optional Calculus<a class="headerlink" href="#the-optional-calculus" title="Permalink to this headline">¶</a></h3>
<p>The following equation represents the rigorous mathematical definition of the
output of a PID controller <img class="math" src="../../_images/math/5b7752c757e0b691a80ab8227eadb8a8389dc58a.svg" alt="f"/> at any given time <img class="math" src="../../_images/math/907a4add6d5db5b7f197f7924f1371b8ac404fe6.svg" alt="t"/>:</p>
<div class="math">
<p><img src="../../_images/math/40287e607a707e7e13b00615c3d77aa46945a9ae.svg" alt="f(t) = K_p e(t) + K_i  \int_o^t e(t) \mathrm{d}t + K_d \frac{\mathrm{d}e(t)}{\mathrm{d}t}"/></p>
</div><p>where <img class="math" src="../../_images/math/19000dd22ecbaac183ad39f8af36e0338076658e.svg" alt="K_p"/>, <img class="math" src="../../_images/math/d4290704da5100a766d9be9a917feb5413b66a53.svg" alt="K_i"/>, and <img class="math" src="../../_images/math/ccfc6cba19c9370da35f7b183d9e737b3843b8ea.svg" alt="K_d"/> are constants and <img class="math" src="../../_images/math/76887f07dbc08b29e8296f7b5da8177a022303b3.svg" alt="e(t)"/>,
as previously mentioned, is the error in the system.
If you have no experience with calculus, don’t worry;
while PID is fundamentally rooted in calculus,
you do not need any calculus experience to be able to understand it,
only basic algebra.
However, you are still urged to read the rest of the section regardless of
calculus experience, as the formula alone doesn’t tell you why it works.</p>
</div>
<div class="section" id="simplification-of-the-pid-formula">
<h3>Simplification of the PID formula<a class="headerlink" href="#simplification-of-the-pid-formula" title="Permalink to this headline">¶</a></h3>
<p>Here is a simplified version of the PID formula:
<img class="math" src="../../_images/math/cea221a282b2268b6ce85819890866194f97b8ca.svg" alt="f(t)=K_p P(t)+K_i I(t)+K_d D(t)"/></p>
<p>All we have done is simply take the full formula and replaced part of the terms
with functions: <img class="math" src="../../_images/math/a3c7182ec35f01796a900808cbb5ad618d1d18e0.svg" alt="P(t)"/>, <img class="math" src="../../_images/math/f18d26a3a2d8ebea3e2c4e5e0108d55122fdd1c6.svg" alt="I(t)"/>, and <img class="math" src="../../_images/math/7a805bc8a332422d1686fce1d37664c589329d42.svg" alt="D(t)"/>.</p>
</div>
<div class="section" id="the-proportional-term">
<h3>The Proportional Term<a class="headerlink" href="#the-proportional-term" title="Permalink to this headline">¶</a></h3>
<p>The first component of the function, <img class="math" src="../../_images/math/cdff034e87b4d716efece6aabdb95430d4bc6427.svg" alt="K_p P(t)"/>,
is by far the most simple and easy to understand, as <img class="math" src="../../_images/math/553c4d76b5f00ef8020d197179d92fe350e34d14.svg" alt="P(t) = e(t)"/>.
For the sake of example, let’s pretend that <img class="math" src="../../_images/math/b1df295acd0dd49b95918d906d90132f4ad6ebf3.svg" alt="K_i=0"/> and <img class="math" src="../../_images/math/58f6bc3bad5c49349bf63836cceaf1732d4deb53.svg" alt="K_d=0"/>
(a PID controller with only a proportional constant is known as a
<strong>P controller</strong>).
How will the system behave?
Well, if the error is large, the output will be large.
Likewise, if the error is small, the output will be small.
Also, ideally, given enough time, the system always approaches its destination,
assuming <img class="math" src="../../_images/math/19000dd22ecbaac183ad39f8af36e0338076658e.svg" alt="K_p"/> is of the correct sign.</p>
<p>Say we apply this to a drivetrain. You want to drive a distance <img class="math" src="../../_images/math/0fcab9067b50b87e868c4fd70f213a086addb964.svg" alt="D"/>,
and you decide to set your motor powers using a P controller to accomplish this.
In this case, your error is how far away the robot is from the desired location.
As you start to drive forward, your error is large,
so you drive forward quickly, which is desirable.
After all, you aren’t concerned with overshooting the target yet if you are far
away from it.
But as the robot’s distance to the target approaches 0,
you will start to slow down, gaining more control over the robot.
Once the error is zero, ideally, the robot will stop, and you have reached your
destination.
If you happen to overshoot, the error will become negative,
and the robot will backtrack, repeating the process.</p>
</div>
<div class="section" id="the-derivative-term">
<h3>The Derivative Term<a class="headerlink" href="#the-derivative-term" title="Permalink to this headline">¶</a></h3>
<p>This term, <img class="math" src="../../_images/math/51968507d750080980c7a309848521e6d9e6f8d9.svg" alt="K_d D(t)"/>, is intended to dampen the rate of change of the
error.
In other words, it tries to keep the error constant.
How is this done?
Well, for those of you with calculus under your belt,
<img class="math" src="../../_images/math/8f9faae542e51a34715c5d55d09b29eeacc200f0.svg" alt="D(t)=\frac{de(t)}{dt}"/>.
For those without calculus experience,
it represents how fast the error is changing.
Graphically, <img class="math" src="../../_images/math/7a805bc8a332422d1686fce1d37664c589329d42.svg" alt="D(t)"/> is simply the slope of the error at any given time
<img class="math" src="../../_images/math/907a4add6d5db5b7f197f7924f1371b8ac404fe6.svg" alt="t"/>.
This slope can be calculated by keeping track of the error over successive
iterations of the control loop.
One iteration occurs at time <img class="math" src="../../_images/math/747fbed09deea417cb22a2956e68ea9d4f9f13a7.svg" alt="t_n"/> with an error of <img class="math" src="../../_images/math/1c9b1da73584c7f3507707f94994d07ca36a7218.svg" alt="e(t_n)"/>.
At the next iteration, the time is <img class="math" src="../../_images/math/91c381a0ff0c47ab49be6e4c5bf1f93e3955bd44.svg" alt="t_{n+1}"/> with an error of
<img class="math" src="../../_images/math/f8eee0dd6a7db789db5a077535da8a4bb20ccfc5.svg" alt="e(t_{n+1})"/>.
Thus, to find <img class="math" src="../../_images/math/7a805bc8a332422d1686fce1d37664c589329d42.svg" alt="D(t)"/>, simply find the slope of <img class="math" src="../../_images/math/76887f07dbc08b29e8296f7b5da8177a022303b3.svg" alt="e(t)"/> given these
two points.</p>
</div>
<div class="section" id="the-integral-term">
<h3>The Integral Term<a class="headerlink" href="#the-integral-term" title="Permalink to this headline">¶</a></h3>
<p>Admittedly, the integral term is the least important term for FTC PID control
loops.
With a properly tuned <img class="math" src="../../_images/math/19000dd22ecbaac183ad39f8af36e0338076658e.svg" alt="K_p"/> and <img class="math" src="../../_images/math/ccfc6cba19c9370da35f7b183d9e737b3843b8ea.svg" alt="K_d"/>, you often can just set
<img class="math" src="../../_images/math/d4290704da5100a766d9be9a917feb5413b66a53.svg" alt="K_i"/> to 0 and call it a day.
However, it can still be useful in some cases.
Just like the derivative term, the integral term intends to correct for
overshoot.
if the system thinks it reached its destination, it will stop, even when,
in fact, the error is not yet 0.
Perhaps the motor is no longer being supplied enough power to move.
Well, given enough time, the integral term will increase the output
(in this case, motor power),
causing movement towards the destination.
To explain without calculus, the integral term essentially sums the error over a
specific interval of time.
To do this, error in each loop iteration is added to a variable (in this case,
<img class="math" src="../../_images/math/f18d26a3a2d8ebea3e2c4e5e0108d55122fdd1c6.svg" alt="I(t)"/>).
However, summing error this way has an unfortunate side effect:
the longer the loop takes to complete one iteration,
the more slowly this sum increases,
which is obviously not desirable,
as we don’t want lag to affect how the robot moves.
To compensate for this, before the error is added to <img class="math" src="../../_images/math/f18d26a3a2d8ebea3e2c4e5e0108d55122fdd1c6.svg" alt="I(t)"/>, it is
multiplied by how long the previous loop took to-complete, or
<img class="math" src="../../_images/math/52fbd4d4a0529c2041b2ca3cc54cfb5fb8c01f16.svg" alt="t_{n+1}-t_n"/>, preventing lag from making the system sum more slowly.</p>
<p>So say the robot stops short of the target.
The P and D combination aren’t strong enough to move it forward to the
destination.
You can either tune <img class="math" src="../../_images/math/19000dd22ecbaac183ad39f8af36e0338076658e.svg" alt="K_p"/> and <img class="math" src="../../_images/math/ccfc6cba19c9370da35f7b183d9e737b3843b8ea.svg" alt="K_d"/> to compensate
(<strong>this is recommended</strong>), or you can add the integral term to increase output
(<strong>this works too, but requires more attention and tuning to achieve the same
result</strong>).</p>
</div>
<div class="section" id="pid-pseudocode">
<h3>PID Pseudocode<a class="headerlink" href="#pid-pseudocode" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="n">get_current_time</span><span class="p">()</span>
    <span class="n">current_error</span> <span class="o">=</span> <span class="n">desire_position</span><span class="o">-</span><span class="n">current_position</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">k_p</span> <span class="o">*</span> <span class="n">current_error</span>

    <span class="n">i</span> <span class="o">+=</span> <span class="n">k_i</span> <span class="o">*</span> <span class="p">(</span><span class="n">current_error</span> <span class="o">*</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">previous_time</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">max_i</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">max_i</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">max_i</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="n">max_i</span>

    <span class="n">D</span> <span class="o">=</span> <span class="n">k_d</span> <span class="o">*</span> <span class="p">(</span><span class="n">current_error</span> <span class="o">-</span> <span class="n">previous_error</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">previous_time</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">d</span>

    <span class="n">previous_error</span> <span class="o">=</span> <span class="n">current_error</span>
    <span class="n">previous_time</span> <span class="o">=</span> <span class="n">current_time</span>
</pre></div>
</div>
</div>
<div class="section" id="tuning-a-pid-loop">
<h3>Tuning a PID Loop<a class="headerlink" href="#tuning-a-pid-loop" title="Permalink to this headline">¶</a></h3>
<p>The most important thing to know while tuning a PID loop is how each of the
terms affects the output.
This can allow you to see which gains need to be adjusted.
For example, if the target is not reached but instead the setpoint begins to
oscillate around the target, it means there is not enough D gain.
If the target is eventually reached, albeit very slowly, that means there is not
enough P gain or the D gain is too high.
In brief, the P variable drives the error towards zero, the I variable corrects
for steady state error, and the D variable dampens the effects of the P
variable, more so as error approaches zero, which prevents overshoot.</p>
<dl class="simple">
<dt>The most common method for tuning a PID controller is as follows:</dt><dd><ol class="arabic simple">
<li><p>Set the I and D gains to zero</p></li>
<li><p>Increase the P gain until there are oscillations around the target</p></li>
<li><p>Increase the D gain until no overshoot occurs</p></li>
<li><p>If there is steady state error, increase the I gain until it is corrected</p></li>
</ol>
</dd>
</dl>
<p>An important thing to note is that most systems do not need both I and D
control.
Generally, systems without a lot of friction do not need an I term,
but will need more D control.
Systems with a lot of friction, on the other hand, generally do not need D
control because the friction facilitates deceleration but need I control because
the friction prevents the system from reaching the target otherwise.</p>
<p><a class="reference external" href="https://blog.wesleyac.com/posts/intro-to-control-part-two-pid-tuning">For a more in-depth explanation, click here</a></p>
</div>
</div>
<div class="section" id="feedforward-control">
<h2>Feedforward Control<a class="headerlink" href="#feedforward-control" title="Permalink to this headline">¶</a></h2>
<p>One less popular but equally useful control loop is the feedforward controller
(sometimes unofficially referred to in FTC as the PVA controller,
or Position-Velocity-Acceleration controller).
For those without a physics background, velocity is the speed and direction
something is moving and acceleration is how fast velocity is increasing or
decreasing.
Unlike PID, feedforward controllers require you to input not only where you want
to go and where you are, but how fast you want to be moving at all times.
Unlike feedback control loops such as PID, feedforward control loops don’t
require information about the variable you want to control.
Instead of controlling a variable directly, it controls how fast that variable
changes.</p>
<p>Conceptually, the controller is made up of 2 separate P controllers
(remember, a P controller is made up of just the proportional term of a PID
loop).
Each of these P controllers are added together to create a feedforward
controller.</p>
<p>Just like we did with the PID formula, we can define the function like this:
<img class="math" src="../../_images/math/ed10d71c3d99a0ca0b57628c05b1f92757f9838e.svg" alt="f(t)=K_v*V(t)+K_a*A(t)"/>.</p>
<p>In most FTC applications, <img class="math" src="../../_images/math/cef4cf670c70c7e481436563fe6832540700500d.svg" alt="f(t)"/> controls the position of the output.
As the name PVA suggests, the first term relates to velocity,
and the second relates to acceleration.
Just like in a P controller,
each term contains a constant multiplied by an error term
(in this case, <img class="math" src="../../_images/math/e3b416a13b3a7db65d8cacf8de5b127d4937d522.svg" alt="V(t)"/> and <img class="math" src="../../_images/math/71ce87ce119204caaee7ad710058daeae890bc9b.svg" alt="A(t)"/>).
However, unlike a PID controller,
each term has their own setpoints and endpoints,
meaning error is calculated differently for each term.</p>
<p>Unlike desired position, your desired velocity is likely to change throughout
the control loop.
After all, the entire point of using control loops are to try to create a
balance of speed and control of a system.
Remember, in most situations, you want to approach your destination quickly
if you are far away and slow down if you are close for more control.
For the sake of example, let’s say <img class="math" src="../../_images/math/1798df042f26d03066e35d2a87015a7ea4ccf04e.svg" alt="v(t)"/> is a magic function that could
tell you exactly how fast you should be going at any point.
To calculate velocity error, subtract your current velocity from the
magic function <img class="math" src="../../_images/math/1798df042f26d03066e35d2a87015a7ea4ccf04e.svg" alt="v(t)"/>. This magic function can also be used to create
another magic function: <img class="math" src="../../_images/math/1a4ceb146679388d6f4b3f78cda11e8a5972fc12.svg" alt="a(t)"/>. This magic function tells you how exactly
how fast the velocity should change in order to get to the next magic velocity
at any specified time.</p>
<p>The last step is finding the magic functions <img class="math" src="../../_images/math/1798df042f26d03066e35d2a87015a7ea4ccf04e.svg" alt="v(t)"/> and <img class="math" src="../../_images/math/1a4ceb146679388d6f4b3f78cda11e8a5972fc12.svg" alt="a(t)"/>,
<strong>which can be obtained using motion profiles</strong> (discussed next).</p>
<div class="section" id="feedforward-pseudocode">
<h3>Feedforward Pseudocode<a class="headerlink" href="#feedforward-pseudocode" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="n">get_current_time</span><span class="p">()</span>

    <span class="n">current_velocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_position</span> <span class="o">-</span> <span class="n">previous_position</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">previous_time</span><span class="p">)</span>
    <span class="n">current_velocity_error</span> <span class="o">=</span> <span class="n">desired_velocity</span> <span class="o">-</span> <span class="n">current_velocity</span>

    <span class="n">current_acceleration</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_velocity</span> <span class="o">-</span> <span class="n">previous_velocity</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">previous_time</span><span class="p">)</span>
    <span class="n">current_acceleration_error</span> <span class="o">=</span> <span class="n">desired_acceleration</span> <span class="o">-</span> <span class="n">current_acceleration</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">F</span> <span class="o">+</span> <span class="n">k_v</span> <span class="o">*</span> <span class="n">current_velocity_error</span> <span class="o">+</span> <span class="n">K_A</span> <span class="o">*</span> <span class="n">current_acceleration_error</span>

    <span class="n">previous_velocity</span> <span class="o">=</span> <span class="n">current_velocity</span>

    <span class="c1"># end of feedforward code</span>

    <span class="n">previous_error</span> <span class="o">=</span> <span class="n">current_error</span>
    <span class="n">previous_time</span> <span class="o">=</span> <span class="n">current_time</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="motion-profiles">
<h2>Motion Profiles<a class="headerlink" href="#motion-profiles" title="Permalink to this headline">¶</a></h2>
<p>Motion profiling is a technique popularized in FRC that is starting to find its
way to FTC.
A motion profile is a function used to change the speed of a power transmission
system in a controlled and consistent way by changing desired speed gradually
rather than instantaneously.
Let’s illustrate this with an example: say you want your drivetrain,
which is initially unmoving, to drive forward at full speed.
Ordinarily, you would set all drivetrain motors to full power in the code.
However, this can be problematic because even though you tell the motors to move
at full speed instantaneously, the drivetrain takes time to get to full speed.
This can lead to uncontrolled movements which have the potential to make
autonomous less consistent and, perhaps more importantly, damage mechanisms.
Motion profiling attempts to solve this issue.</p>
<div class="section" id="advantages">
<h3>Advantages<a class="headerlink" href="#advantages" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>More controlled and predictable movements</p></li>
<li><p>Reduces rapid change of applied motor voltage</p></li>
</ul>
</div>
<div class="section" id="disadvantages">
<h3>Disadvantages<a class="headerlink" href="#disadvantages" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Can be slower</p></li>
</ul>
<p>There are two main types of motion profiles: <strong>Trapezoidal</strong> profiles and
<strong>S-Curve</strong> profiles.
Trapezoidal profiles accelerate the system at a constant rate,
and S-Curve profiles assume jerk (the speed acceleration changes) is constant.
Given that S-Curve profiles are not optimal for controlling 2d trajectories
(such as driving) and exist to reduce slippage
(which usually only occurs when driving in FTC), trapezoidal profiles are
recommended for most FTC applications.</p>
<p>Trapezoidal profiles get their name from the shape of the graph of velocity over
time:</p>
<div class="figure align-default" id="id1">
<img alt="The position over time, velocity over time, and acceleration over time graphs for a trapezoidal motion profile" src="../../_images/trapezoidal-motion-profiling-graph.png" />
<p class="caption"><span class="caption-text">These are the “magic functions” for velocity and acceleration over time
alluded to in the feedforward section.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>Here is some pseudocode for a trapezoidal profile:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">current_velocity</span> <span class="o">=</span> <span class="n">get_current_velocity</span><span class="p">()</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="n">get_current_time</span><span class="p">()</span>

    <span class="n">direction_multiplier</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">position_error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">direction_multiplier</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># if maximum speed has not been reached</span>
    <span class="k">if</span> <span class="n">MAXIMUM_SPEED</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_velocity</span><span class="p">):</span>
        <span class="n">output_velocity</span> <span class="o">=</span> <span class="n">current_velocity</span> <span class="o">+</span> <span class="n">direction_multiplier</span> <span class="o">*</span> <span class="n">MAX_ACCELERATION</span> <span class="o">*</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">previous_time</span><span class="p">)</span>
        <span class="n">output_acceleration</span> <span class="o">=</span> <span class="n">MAX_ACCELERATION</span>

    <span class="c1">#if maximum speed has been reached, stay there for now</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputVelocity</span> <span class="o">=</span> <span class="n">MAXIMUM_SPEED</span>
        <span class="n">outputAcceleration</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#if we are close enough to the object to begin slowing down</span>
    <span class="k">if</span> <span class="n">position_error</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">output_velocity</span> <span class="o">*</span> <span class="n">output_velocity</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">MAX_ACCELERATION</span><span class="p">)):</span>
        <span class="n">output_velocity</span> <span class="o">=</span> <span class="n">current_velocity</span> <span class="o">-</span> <span class="n">direction_multiplier</span> <span class="o">*</span> <span class="n">MAX_ACCELERATION</span> <span class="o">*</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">previous_time</span><span class="p">)</span>
        <span class="n">output_acceleration</span> <span class="o">=</span> <span class="o">-</span><span class="n">MAX_ACCELERATION</span>


    <span class="n">previous_time</span> <span class="o">=</span> <span class="n">current_time</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../appendix/index.html" class="btn btn-neutral float-right" title="Appendix" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mecanum-drive.html" class="btn btn-neutral float-left" title="Programming Tutorial - Mecanum Drivetrain" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Game Manual 0 Contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>

  
  
    
   

</body>
</html>